@using Blazix.RovingFocusGroup
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Logging
@using Microsoft.JSInterop
@using System.Diagnostics.CodeAnalysis

@typeparam TValue

@implements IAsyncDisposable

@inject IJSRuntime JSRuntime
@inject ILogger<RadioGroupItem<TValue>> Logger

@{
    bool isChecked = false;
    bool isGroupDisabled = false;
    string? groupName = null;
    bool isRequired = false;

    if (Context != null)
    {
        isChecked = EqualityComparer<TValue>.Default.Equals(Context.SelectedValue, Value);
        isGroupDisabled = Context.IsGroupDisabled;
        groupName = Context.Name;
        isRequired = Context.Required;
    }

    bool actualItemDisabled = isGroupDisabled || Disabled;
    var itemContext = new RadioGroupItemContext(isChecked, actualItemDisabled);
}

<RovingFocusGroupItem @ref="rovingFocusGroupItem"
                      Focusable="!actualItemDisabled"
                      Active="isChecked">
    <CascadingValue Value="itemContext"
                    IsFixed="false">
        <button type="button"
                role="radio"
                aria-checked="@isChecked.ToString().ToLowerInvariant()"
                data-state="@(isChecked ? "checked" : "unchecked")"
                data-disabled="@(actualItemDisabled ? string.Empty : null)"
                disabled="@actualItemDisabled"
                value="@(Value is not null ? BindConverter.FormatValue(Value.ToString()) : null)"
                tabindex="@rovingFocusGroupItem?.TabIndex"
                @attributes="AdditionalAttributes"
                @onclick="HandleClick"
                @onclick:stopPropagation="IsFormControl"
                @onfocus="HandleFocus"
                @onmousedown="HandleMouseDown"
                @ref="Element">
            @ChildContent
        </button>
    </CascadingValue>
</RovingFocusGroupItem>

@if (IsFormControl)
{
    <InputRadio TValue="TValue"
                @ref="inputRadio"
                aria-hidden="true"
                name="@groupName"
                Value="@Value"
                disabled="@actualItemDisabled"
                required="@isRequired"
                tabindex="-1"
                style="transform: translateX(-100%); position: absolute; pointer-events: none; opacity: 0; margin: 0;" />
}

@code {
    private RovingFocusGroupItem? rovingFocusGroupItem;
    private InputRadio<TValue>? inputRadio;
    private Lazy<Task<IJSObjectReference>> moduleTask = default!;

    private bool IsFormControl => EditContext != null;

    [CascadingParameter]
    private EditContext? EditContext { get; set; }

    [CascadingParameter]
    private RadioGroupContext<TValue>? Context { get; set; }

    [Parameter, EditorRequired]
    public TValue Value { get; set; } = default!;

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }

    [DisallowNull]
    public ElementReference? Element { get; protected set; }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        moduleTask = new(() => JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Blazix/blazix-radiogroup.js").AsTask());
    }

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
        if (Context is null)
        {
            throw new InvalidOperationException($"'{nameof(RadioGroupItem<TValue>)}' must be used within a '{nameof(RadioGroupRoot<TValue>)}' component that provides a '{nameof(RadioGroupContext<TValue>)}'.");
        }
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var module = await moduleTask.Value;
        if (firstRender)
        {
            rovingFocusGroupItem?.SetElement(Element);
            await (rovingFocusGroupItem?.InitializeAsync() ?? Task.CompletedTask);
            try
            {
                if (module is not null)
                {
                    await module.InvokeVoidAsync("addArrowKeyListeners");
                }
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { /* Swallow */ }
            catch (Exception ex)
            {
                Logger.LogError("Error importing blazix-radiogroup.js: {ErrorMessage}", ex.Message);
            }
        }

        if (module is not null && IsFormControl && Element.HasValue && inputRadio?.Element != null)
        {
            await module.InvokeVoidAsync("syncInputSize", Element.Value, inputRadio.Element.Value);
        }
    }

    /// <inheritdoc />
    public async ValueTask DisposeAsync()
    {
        if (moduleTask.IsValueCreated)
        {
            try
            {
                var module = await moduleTask.Value;
                if (module != null)
                {
                    await module.InvokeVoidAsync("removeArrowKeyListeners", Element);
                    await module.DisposeAsync();
                }
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { /* Swallow */ }
        }
    }

    private async Task HandleClick()
    {
        if (Context is null) return;

        bool isChecked = EqualityComparer<TValue>.Default.Equals(Context.SelectedValue, Value);
        bool actualItemDisabled = Context.IsGroupDisabled || Disabled;

        if (actualItemDisabled) return;

        if (!isChecked)
        {
            await Context.OnValueChange(Value);
        }

        var module = await moduleTask.Value;
        if (IsFormControl && module != null && inputRadio?.Element != null)
        {
            await module.InvokeVoidAsync("triggerClick", inputRadio.Element.Value);
        }
    }

    private async Task HandleFocus()
    {
        var module = await moduleTask.Value;

        if (module is not null)
        {
            rovingFocusGroupItem?.Focus();

            bool isArrowKeyPressed = await module.InvokeAsync<bool>("isArrowKeyPressed");

            if (isArrowKeyPressed)
            {
                await HandleClick();
            }
        }
    }

    private void HandleMouseDown() => rovingFocusGroupItem?.OnMouseDown();
}