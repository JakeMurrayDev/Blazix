@using System.Diagnostics.CodeAnalysis
@using Blazix.RovingFocusGroup
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Logging
@using Microsoft.JSInterop

@typeparam TValue

@implements IAsyncDisposable

@inject IJSRuntime JSRuntime
@inject ILogger<RadioGroupItem<TValue>> Logger

<RovingFocusGroupItem @ref="rovingFocusGroupItem"
                      Focusable="!ActualDisabled"
                      Active="IsChecked">
    <CascadingValue Value="ItemContext" IsFixed="false">
        <button type="button"
                role="radio"
                aria-checked="@IsChecked.ToString().ToLowerInvariant()"
                data-state="@(IsChecked ? "checked" : "unchecked")"
                data-disabled="@(ActualDisabled ? string.Empty : null)"
                disabled="@ActualDisabled"
                value="@(Value is not null ? BindConverter.FormatValue(Value.ToString()) : null)"
                tabindex="@rovingFocusGroupItem?.TabIndex"
                @attributes="AdditionalAttributes"
                @onclick="HandleClick"
                @onclick:stopPropagation="IsFormControl"
                @onfocus="HandleFocus"
                @onmousedown="HandleMouseDown"
                @ref="Element">
            @ChildContent
        </button>
    </CascadingValue>
</RovingFocusGroupItem>

@if (IsFormControl)
{
    <InputRadio TValue="TValue"
                @ref="inputRadio"
                aria-hidden="true"
                name="@Context?.Name"
                Value="@Value"
                disabled="@ActualDisabled"
                required="@(Context?.Required ?? false)"
                tabindex="-1"
                style="transform: translateX(-100%); position: absolute; pointer-events: none; opacity: 0; margin: 0;" />
}

@code {
    private RovingFocusGroupItem? rovingFocusGroupItem;
    private InputRadio<TValue>? inputRadio;
    private Lazy<Task<IJSObjectReference>> moduleTask = default!;

    private bool IsFormControl => EditContext != null;
    private bool IsChecked => Context != null &&
        EqualityComparer<TValue>.Default.Equals(Context.SelectedValue, Value);
    private bool ActualDisabled => (Context?.IsGroupDisabled ?? false) || Disabled;
    private RadioGroupItemContext ItemContext => new(IsChecked, ActualDisabled);

    [CascadingParameter]
    private EditContext? EditContext { get; set; }

    [CascadingParameter]
    private RadioGroupContext<TValue>? Context { get; set; }

    /// <summary>
    /// Gets or sets the value given as data when submitted with a name.
    /// </summary>
    [Parameter, EditorRequired]
    public TValue Value { get; set; } = default!;

    /// <summary>
    /// When <see langword="true" />, prevents the user from interacting with the radio item.
    /// Defaults to false.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Defines the child components of this instance.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets a collection of additional attributes that will be applied to the created element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }

    /// <summary>
    /// Gets or sets the associated <see cref="ElementReference"/>.
    /// <para>
    /// May be <see langword="null"/> if accessed before the component is rendered.
    /// </para>
    /// </summary>
    [DisallowNull]
    public ElementReference? Element { get; protected set; }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        moduleTask = new(() => JSRuntime.InvokeAsync<IJSObjectReference>(
            "import", "./_content/Blazix/blazix-radiogroup.js").AsTask());
    }

    /// <inheritdoc />
    protected override void OnParametersSet()
    {
        if (Context is null)
        {
            throw new InvalidOperationException(
                $"'{nameof(RadioGroupItem<TValue>)}' must be used within a " +
                $"'{nameof(RadioGroupRoot<TValue>)}' component.");
        }
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            rovingFocusGroupItem?.SetElement(Element);
            await (rovingFocusGroupItem?.InitializeAsync() ?? Task.CompletedTask);

            try
            {
                var module = await moduleTask.Value;
                await module.InvokeVoidAsync("addArrowKeyListeners");
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing RadioGroupItem JS module");
            }
        }

        if (IsFormControl && Element.HasValue && inputRadio?.Element != null)
        {
            try
            {
                var module = await moduleTask.Value;
                await module.InvokeVoidAsync("syncInputSize", Element.Value, inputRadio.Element.Value);
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { }
        }
    }

    /// <inheritdoc />
    public async ValueTask DisposeAsync()
    {
        if (moduleTask.IsValueCreated)
        {
            try
            {
                var module = await moduleTask.Value;
                await module.InvokeVoidAsync("removeArrowKeyListeners");
                await module.DisposeAsync();
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { }
        }
    }

    private async Task HandleClick()
    {
        if (Context is null || ActualDisabled) return;

        if (!IsChecked)
        {
            await Context.OnValueChange(Value);
        }

        if (IsFormControl && inputRadio?.Element != null)
        {
            try
            {
                var module = await moduleTask.Value;
                await module.InvokeVoidAsync("triggerClick", inputRadio.Element.Value);
            }
            catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { }
        }
    }

    private async Task HandleFocus()
    {
        rovingFocusGroupItem?.Focus();

        try
        {
            var module = await moduleTask.Value;
            bool isArrowKeyPressed = await module.InvokeAsync<bool>("isArrowKeyPressed");

            if (isArrowKeyPressed)
            {
                await HandleClick();
            }
        }
        catch (Exception ex) when (ex is JSDisconnectedException or TaskCanceledException) { }
    }

    private void HandleMouseDown() => rovingFocusGroupItem?.OnMouseDown();
}